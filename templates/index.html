<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinanzApp - Pron√≥stico Financiero</title>
    <style>
      :root {
        /* Paleta profesional y sobria */
        --primary-gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        --dark-bg: #0a0e1a;
        --card-bg: rgba(15, 23, 42, 0.85);
        --card-border: rgba(71, 85, 105, 0.4);
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;

        /* Verde: fondos oscuros + texto claro */
        --success: #047857;
        --success-light: #059669;
        --success-bg: rgba(6, 78, 59, 0.4);
        --success-border: rgba(16, 185, 129, 0.5);
        --success-text: #d1fae5;

        /* Amarillo/Naranja: fondos oscuros + texto claro */
        --warning: #b45309;
        --warning-light: #d97706;
        --warning-bg: rgba(120, 53, 15, 0.4);
        --warning-border: rgba(245, 158, 11, 0.5);
        --warning-text: #fef3c7;

        /* Rojo: fondos oscuros + texto claro */
        --danger: #b91c1c;
        --danger-light: #dc2626;
        --danger-bg: rgba(127, 29, 29, 0.4);
        --danger-border: rgba(239, 68, 68, 0.5);
        --danger-text: #fecaca;

        /* Glass effect m√°s opaco */
        --glass-bg: rgba(15, 23, 42, 0.7);
        --glass-border: rgba(71, 85, 105, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--dark-bg);
        background-image:
          radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.2) 0px, transparent 50%),
          radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.2) 0px, transparent 50%),
          radial-gradient(at 100% 100%, rgba(217, 70, 239, 0.2) 0px, transparent 50%),
          radial-gradient(at 0% 100%, rgba(99, 102, 241, 0.2) 0px, transparent 50%);
        padding: 20px;
        min-height: 100vh;
        color: var(--text-primary);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 40px;
        box-shadow:
          0 8px 32px 0 rgba(0, 0, 0, 0.37),
          inset 0 1px 0 0 rgba(255, 255, 255, 0.1);
      }

      h1 {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
        font-size: 2.8em;
        font-weight: 800;
        letter-spacing: -0.02em;
      }

      .subtitle {
        color: var(--text-secondary);
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      /* SEM√ÅFORO FINANCIERO */
      .semaforo {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .mes-card {
        padding: 24px;
        border-radius: 16px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .mes-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, transparent, currentColor, transparent);
        opacity: 0.5;
      }

      .mes-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .mes-card.verde {
        background: var(--success-bg);
        border-color: var(--success-border);
      }

      .mes-card.verde::before {
        background: linear-gradient(90deg, transparent, var(--success-light), transparent);
      }

      .mes-card.amarillo {
        background: var(--warning-bg);
        border-color: var(--warning-border);
      }

      .mes-card.amarillo::before {
        background: linear-gradient(90deg, transparent, var(--warning-light), transparent);
      }

      .mes-card.rojo {
        background: var(--danger-bg);
        border-color: var(--danger-border);
      }

      .mes-card.rojo::before {
        background: linear-gradient(90deg, transparent, var(--danger-light), transparent);
      }

      .mes-nombre {
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text-primary);
      }

      .mes-dato {
        font-size: 0.9em;
        margin: 8px 0;
        color: var(--text-secondary);
      }

      .saldo-grande {
        font-size: 2em;
        font-weight: 700;
        margin: 12px 0;
      }

      .mes-card.verde .saldo-grande {
        color: var(--success-text);
      }

      .mes-card.amarillo .saldo-grande {
        color: var(--warning-text);
      }

      .mes-card.rojo .saldo-grande {
        color: var(--danger-text);
      }

      /* BOTONES PRINCIPALES */
      .acciones-principales {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .btn-principal {
        padding: 20px 24px;
        border: 1px solid var(--card-border);
        border-radius: 12px;
        font-size: 1.05em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        background: var(--card-bg);
        color: var(--text-primary);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
      }

      .btn-principal::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s;
      }

      .btn-principal:hover::before {
        left: 100%;
      }

      .btn-principal:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .btn-principal:active {
        transform: translateY(0);
      }

      .btn-simulador {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: rgba(16, 185, 129, 0.5);
        font-size: 1.2em;
      }

      .btn-gasto {
        background: var(--primary-gradient);
        border-color: rgba(99, 102, 241, 0.5);
      }

      .btn-prestamo {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        border-color: rgba(236, 72, 153, 0.5);
      }

      .btn-tarjeta {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-color: rgba(59, 130, 246, 0.5);
      }

      .btn-ingreso {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: rgba(16, 185, 129, 0.5);
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(8px);
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      .modal-content {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        max-width: 600px;
        margin: 50px auto;
        padding: 32px;
        border-radius: 20px;
        position: relative;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 24px;
        font-size: 1.8em;
        cursor: pointer;
        color: var(--text-secondary);
        transition: all 0.2s;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
      }

      .close-modal:hover {
        color: var(--text-primary);
        background: var(--card-bg);
      }

      /* FORMULARIOS */
      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95em;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--card-border);
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 10px;
        font-size: 1em;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .btn-submit {
        width: 100%;
        padding: 14px 24px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.05em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
      }

      .btn-submit::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .btn-submit:hover::before {
        left: 100%;
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
      }

      .btn-submit:active {
        transform: translateY(0);
      }

      /* RESULTADO SIMULADOR */
      .resultado-simulacion {
        margin-top: 20px;
        padding: 20px;
        border-radius: 12px;
        display: none;
      }

      .veredicto {
        font-size: 1.5em;
        font-weight: 700;
        text-align: center;
        padding: 24px;
        border-radius: 16px;
        margin: 20px 0;
        border: 1px solid;
        backdrop-filter: blur(10px);
      }

      .veredicto.si {
        background: var(--success-bg);
        color: var(--success-text);
        border-color: var(--success-border);
      }

      .veredicto.cuidado {
        background: var(--warning-bg);
        color: var(--warning-text);
        border-color: var(--warning-border);
      }

      .veredicto.no {
        background: var(--danger-bg);
        color: var(--danger-text);
        border-color: var(--danger-border);
      }

      /* SECCIONES */
      .section {
        margin: 40px 0;
        padding: 24px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        backdrop-filter: blur(10px);
      }

      .section h2 {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: 700;
      }

      .section h3 {
        color: var(--text-primary);
        margin: 20px 0 15px;
        font-size: 1.2em;
        font-weight: 600;
      }

      /* TABLAS */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        border-radius: 12px;
        overflow: hidden;
      }

      th,
      td {
        padding: 14px 16px;
        text-align: left;
        border-bottom: 1px solid var(--card-border);
      }

      th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      tr {
        transition: background 0.2s;
      }

      tr:hover {
        background: var(--card-bg);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      /* Links en tablas */
      a {
        color: #6366f1;
        text-decoration: none;
        transition: color 0.2s;
      }

      a:hover {
        color: #8b5cf6;
      }

      /* ESTILOS PARA INPUTS DE FECHA PERSONALIZADOS */
      .date-input-group {
        display: flex;
        gap: 12px;
      }

      .date-field {
        flex: 1;
      }

      .date-field label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.85em;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .date-field input,
      .date-field select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--card-border);
        background: var(--card-bg);
        color: var(--text-primary);
        border-radius: 8px;
        font-size: 0.95em;
        transition: all 0.2s;
      }

      .date-field input:focus,
      .date-field select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .date-field input.invalid {
        border-color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
      }

      .date-error {
        color: var(--danger);
        font-size: 0.85em;
        margin-top: 6px;
        display: none;
        font-weight: 600;
      }

      /* Mensajes de informaci√≥n */
      small {
        color: var(--text-secondary);
        font-size: 0.9em;
      }

      /* Badges y tags */
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
      }

      /* Scrollbar personalizado */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      ::-webkit-scrollbar-track {
        background: var(--card-bg);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--card-border);
        border-radius: 5px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .semaforo {
          grid-template-columns: 1fr;
        }

        .acciones-principales {
          grid-template-columns: 1fr;
        }

        .modal-content {
          padding: 24px;
          margin: 20px auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üí∞ Pron√≥stico Financiero</h1>

      <!-- MENSAJES FLASH -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div style="margin-bottom: 20px;">
            {% for category, message in messages %}
              <div style="padding: 15px; border-radius: 10px; margin-bottom: 10px;
                          background: {% if category == 'error' %}rgba(127, 29, 29, 0.4){% elif category == 'success' %}rgba(6, 78, 59, 0.4){% else %}rgba(29, 78, 127, 0.4){% endif %};
                          color: {% if category == 'error' %}#fecaca{% elif category == 'success' %}#d1fae5{% else %}#bfdbfe{% endif %};
                          border-left: 4px solid {% if category == 'error' %}#dc2626{% elif category == 'success' %}#10b981{% else %}#3b82f6{% endif %};
                          border: 1px solid {% if category == 'error' %}rgba(239, 68, 68, 0.5){% elif category == 'success' %}rgba(16, 185, 129, 0.5){% else %}rgba(59, 130, 246, 0.5){% endif %};">
                <strong>{% if category == 'error' %}‚ùå{% elif category == 'success' %}‚úÖ{% else %}‚ÑπÔ∏è{% endif %}</strong> {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- FILTRO DE PERIODO -->
      <div style="margin-bottom: 15px; text-align: center;">
        <div style="display: inline-flex; background: rgba(15, 23, 42, 0.6); border-radius: 10px; padding: 5px; gap: 5px;">
          <button
            id="btnTodoTiempo"
            onclick="cambiarPeriodo('todo')"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border: none;
              color: white;
              padding: 10px 25px;
              border-radius: 8px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.3s;
            ">
            üìÖ Todo el tiempo
          </button>
          <button
            id="btnEsteMes"
            onclick="cambiarPeriodo('mes')"
            style="
              background: transparent;
              border: 1px solid rgba(255,255,255,0.2);
              color: #cbd5e1;
              padding: 10px 25px;
              border-radius: 8px;
              cursor: pointer;
              font-weight: 600;
              transition: all 0.3s;
            ">
            üìÜ Este mes
          </button>
        </div>
      </div>

      <!-- BALANCE INICIAL Y ACTUAL -->
      <div
        style="
          background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
          padding: 20px;
          border-radius: 15px;
          margin-bottom: 20px;
          color: white;
        "
      >
        <div
          style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px"
        >
          <div>
            <div style="font-size: 0.8em; opacity: 0.8">üíµ Saldo inicial</div>
            <div id="labelPeriodoInicial" style="font-size: 0.7em; opacity: 0.7; margin-bottom: 5px;">(Al comenzar a usar la app)</div>
            <div id="saldoInicial" style="font-size: 2em; font-weight: bold">
              ${{ "%.2f"|format(balance_inicial) }}
            </div>
            <button
              onclick="abrirEditarBalance()"
              style="
                background: rgba(255, 255, 255, 0.3);
                border: none;
                color: white;
                padding: 5px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 5px;
              "
            >
              ‚úèÔ∏è Editar
            </button>
            <button
              onclick="abrirVistaQuincenal()"
              style="
                background: {% if vista_quincenal == 1 %}rgba(99, 102, 241, 0.5){% else %}rgba(255, 255, 255, 0.2){% endif %};
                border: none;
                color: white;
                padding: 5px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 5px;
              "
            >
              üìä Vista {% if vista_quincenal == 1 %}Quincenal ‚úì{% else %}Mensual{% endif %}
            </button>
          </div>
          <div>
            <div style="font-size: 0.8em; opacity: 0.8">
              üìä Movimientos registrados
            </div>
            <div id="labelPeriodoMovimientos" style="font-size: 0.7em; opacity: 0.7; margin-bottom: 5px;">(Hasta hoy)</div>
            <div id="totalIngresos" style="font-size: 1.2em; font-weight: 700; color: #d1fae5; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
              +${{ "%.2f"|format(total_ingresos) }}
            </div>
            <div id="totalGastos" style="font-size: 1.2em; font-weight: 700; color: #fecaca; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
              -${{ "%.2f"|format(total_gastos) }}
            </div>
          </div>
          <div style="text-align: right">
            <div style="font-size: 0.8em; opacity: 0.8">üí∞ Saldo actual</div>
            <div id="labelPeriodoActual" style="font-size: 0.7em; opacity: 0.7; margin-bottom: 5px;">(A d√≠a de hoy)</div>
            <div id="saldoActual" style="font-size: 2.5em; font-weight: bold">
              ${{ "%.2f"|format(balance) }}
            </div>
          </div>
        </div>
      </div>

      <!-- PROYECCI√ìN QUINCENAL -->
      {% if vista_quincenal == 1 and proyeccion_quincenal %}
      <div style="background: rgba(15, 23, 42, 0.85); border: 2px solid rgba(99, 102, 241, 0.5); border-radius: 15px; padding: 20px; margin-bottom: 30px;">
        <h2 style="color: #818cf8; margin-bottom: 15px">
          üìä Proyecci√≥n Quincenal Personalizada
        </h2>
        <p style="color: #94a3b8; font-size: 0.9em; margin-bottom: 15px;">
          Fechas de pago: d√≠a {{ fecha_pago_1 }} y {{ fecha_pago_2 }} de cada mes
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; max-height: 600px; overflow-y: auto; padding: 10px;">
          {% for q in proyeccion_quincenal %}
          <div class="mes-card {{ q.estado }}" style="min-height: 180px;">
            <div class="mes-nombre" style="font-size: 0.95em;">
              {% if q.estado == 'verde' %}üü¢{% elif q.estado == 'amarillo' %}üü°{% else %}üî¥{% endif %} {{ q.quincena }}
            </div>
            <div class="mes-dato" style="color: #4caf50; font-size: 0.85em;">
              +Ingresos: ${{ "%.2f"|format(q.ingresos) }}
            </div>
            <div class="mes-dato" style="color: #f44336; font-size: 0.85em;">
              -Pagos: ${{ "%.2f"|format(q.pagos) }}
            </div>
            <div class="saldo-grande" style="font-size: 1.3em;">
              ${{ "%.2f"|format(q.saldo_estimado) }}
            </div>
            <div class="mes-dato" style="font-weight: 600; font-size: 0.85em;">
              {% if q.estado == 'verde' %}
                ‚úÖ Excelente
              {% elif q.estado == 'amarillo' %}
                ‚ö†Ô∏è Ajustado
              {% else %}
                ‚ùå En riesgo
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <div style="margin-top: 15px; text-align: center;">
          <small style="color: #94a3b8;">
            Mostrando {{ proyeccion_quincenal|length }} quincenas ({{ (proyeccion_quincenal|length / 2)|int }} meses)
          </small>
        </div>
      </div>
      {% endif %}

      <!-- DASHBOARD DE ALERTAS -->
      {% if alertas %}
      <div
        style="
          background: rgba(15, 23, 42, 0.85);
          border: 2px solid rgba(99, 102, 241, 0.5);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 30px;
        "
      >
        <h2 style="color: #818cf8; margin-bottom: 15px">
          üîî Pr√≥ximos Pagos (15 d√≠as)
        </h2>
        <div style="display: grid; gap: 10px">
          {% for alerta in alertas %}
          <div
            style="background: {% if alerta.urgencia == 'urgente' %}rgba(127, 29, 29, 0.4){% elif alerta.urgencia == 'proximo' %}rgba(120, 53, 15, 0.4){% else %}rgba(6, 78, 59, 0.4){% endif %};
                            padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
                            border: 1px solid {% if alerta.urgencia == 'urgente' %}rgba(239, 68, 68, 0.5){% elif alerta.urgencia == 'proximo' %}rgba(245, 158, 11, 0.5){% else %}rgba(16, 185, 129, 0.5){% endif %};
                            border-left: 4px solid {% if alerta.urgencia == 'urgente' %}#dc2626{% elif alerta.urgencia == 'proximo' %}#f59e0b{% else %}#10b981{% endif %};"
          >
            <div>
              <strong style="font-size: 1.1em; color: #f1f5f9;">{{ alerta.nombre }}</strong>
              <div style="margin: 5px 0">
                <span
                  style="background: {% if alerta.urgencia == 'urgente' %}#dc2626{% elif alerta.urgencia == 'proximo' %}#d97706{% else %}#059669{% endif %};
                                         color: #f1f5f9; padding: 3px 10px; border-radius: 5px; font-size: 0.85em; font-weight: bold;"
                >
                  {% if alerta.dias_restantes == 0 %}¬°HOY! {% elif
                  alerta.dias_restantes == 1 %}MA√ëANA {% else %}En {{
                  alerta.dias_restantes }} d√≠as{% endif %}
                </span>
                <span style="margin-left: 10px; color: #cbd5e1;">
                  üìÖ {{ alerta.fecha_pago.strftime('%d/%m/%Y') }}
                </span>
              </div>
              {% if alerta.notas %}
              <div style="font-size: 0.85em; color: #cbd5e1; margin-top: 5px">
                üí° {{ alerta.notas }}
              </div>
              {% endif %}
            </div>
            <div style="text-align: right">
              <div style="font-size: 1.5em; font-weight: bold; color: {% if alerta.urgencia == 'urgente' %}#fecaca{% elif alerta.urgencia == 'proximo' %}#fef3c7{% else %}#d1fae5{% endif %};">
                ${{ "%.2f"|format(alerta.monto) }}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- ACCIONES PRINCIPALES -->
      <div class="acciones-principales">
        <a href="/dashboard" class="btn-principal" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-color: rgba(59, 130, 246, 0.5); text-decoration: none; display: flex; align-items: center; justify-content: center;">
          üìä VER DASHBOARD
        </a>
        <button class="btn-principal btn-simulador" onclick="abrirSimulador()">
          üõí SIMULAR COMPRA
        </button>
        <button
          class="btn-principal"
          style="
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
          "
          onclick="abrirIngresoRecurrente()"
        >
          üí∞ Ingreso Recurrente
        </button>
        <button
          class="btn-principal btn-prestamo"
          onclick="abrirRegistroCredito()"
        >
          üí≥ Agregar Pr√©stamo
        </button>
        <button
          class="btn-principal btn-tarjeta"
          onclick="abrirRegistroTarjeta()"
        >
          üí≥ Agregar Tarjeta de Cr√©dito
        </button>
        <button
          class="btn-principal btn-ingreso"
          onclick="abrirRegistroIngreso()"
        >
          üíµ Registrar Ingreso
        </button>
        <button
          class="btn-principal btn-gasto"
          onclick="abrirRegistroGasto()"
        >
          üí≥ Registrar Nuevo Gasto
        </button>
      </div>

      <!-- INGRESOS Y GASTOS R√ÅPIDOS -->
      <div
        style="
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 40px;
        "
      >
        <!-- INGRESOS -->
        <div class="section" style="margin: 0">
          <h2>üìä Ingresos Recientes</h2>
          {% if ingresos %}
          <div style="max-height: 300px; overflow-y: auto">
            {% for ingreso in ingresos %}
            <div
              style="
                background: rgba(6, 78, 59, 0.2);
                padding: 10px;
                margin: 5px 0;
                border-radius: 5px;
                border: 1px solid rgba(16, 185, 129, 0.3);
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div>
                <strong>{{ ingreso[1] }}</strong> - {{ ingreso[2] }}<br />
                <span
                  style="color: #4caf50; font-size: 1.2em; font-weight: bold"
                  >${{ "%.2f"|format(ingreso[3]) }}</span
                >
              </div>
              <a
                href="/borrar_ingreso/{{ ingreso[0] }}"
                class="btn-delete"
                style="
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øBorrar este ingreso?')"
              >
                üóëÔ∏è
              </a>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p style="color: #94a3b8">No hay ingresos registrados a√∫n.</p>
          {% endif %}
        </div>

        <!-- GASTOS RECIENTES (solo efectivo/transferencia ya pagados) -->
        <div class="section" style="margin: 0">
          <h2>üíµ Gastos Recientes</h2>
          {% if gastos %}
          <div style="max-height: 450px; overflow-y: auto">
            {% for gasto in gastos %}
            <div
              style="
                background: rgba(127, 29, 29, 0.2);
                padding: 10px;
                margin: 5px 0;
                border-radius: 5px;
                border: 1px solid rgba(239, 68, 68, 0.3);
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div>
                <strong>{{ gasto[1] }}</strong> - {{ gasto[3] }}<br />
                <span
                  style="color: #f44336; font-size: 1.1em; font-weight: bold"
                  >${{ "%.2f"|format(gasto[4]) }}</span
                >
                <span
                  style="background: #{% if gasto[2] == 'credito' %}ffc107{% else %}2196f3{% endif %}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;"
                >
                  {{ gasto[2] }}
                </span>
              </div>
              <a
                href="/borrar_gasto/{{ gasto[0] }}"
                class="btn-delete"
                style="
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øBorrar este gasto?')"
              >
                üóëÔ∏è
              </a>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p style="color: #94a3b8">No hay gastos en efectivo registrados.</p>
          {% endif %}
        </div>

        <!-- PAGOS PENDIENTES DE TARJETA -->
        <div class="section" style="margin: 20px 0 0 0">
          <h2>üí≥ Pagos Pendientes de Tarjeta</h2>
          {% if gastos_tdc %}
          <div style="max-height: 450px; overflow-y: auto">
            {% set current_tarjeta = namespace(nombre='') %}
            {% set tarjeta_total = namespace(valor=0) %}

            {% for gasto_tdc in gastos_tdc %}
              <!-- Si cambia de tarjeta, cerrar el grupo anterior y abrir uno nuevo -->
              {% if current_tarjeta.nombre != gasto_tdc['tarjeta_nombre'] %}
                <!-- Cerrar grupo anterior si no es el primero -->
                {% if current_tarjeta.nombre != '' %}
                  <div style="padding: 8px; background: rgba(156, 39, 176, 0.15); border-top: 1px solid rgba(156, 39, 176, 0.3); margin-top: -5px; border-radius: 0 0 5px 5px; font-weight: bold; color: #9c27b0;">
                    Total a pagar: ${{ "%.2f"|format(tarjeta_total.valor) }}
                  </div>
                  </div>
                {% endif %}

                <!-- Abrir nuevo grupo de tarjeta -->
                {% set current_tarjeta.nombre = gasto_tdc['tarjeta_nombre'] %}
                {% set tarjeta_total.valor = 0 %}

                <div style="margin: 10px 0;">
                  <div style="background: rgba(156, 39, 176, 0.2); padding: 10px; border-radius: 5px 5px 0 0; border: 1px solid rgba(156, 39, 176, 0.4); border-bottom: none;">
                    <strong style="color: #9c27b0; font-size: 1.1em;">üí≥ {{ gasto_tdc['tarjeta_nombre'] }}</strong>
                    <br>
                    <small style="color: #94a3b8;">Pago estimado: d√≠a {{ gasto_tdc['fecha_pago_estimada'] }} de cada mes</small>
                  </div>
              {% endif %}

              <!-- Agregar al total de la tarjeta actual -->
              {% set tarjeta_total.valor = tarjeta_total.valor + gasto_tdc['monto'] %}

              <!-- Mostrar el gasto -->
              <div style="background: rgba(127, 29, 29, 0.1); padding: 8px 10px; border-left: 1px solid rgba(156, 39, 176, 0.4); border-right: 1px solid rgba(156, 39, 176, 0.4); display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <span style="color: #e2e8f0;">{{ gasto_tdc['concepto'] }}</span>
                  <span style="color: #f44336; font-weight: bold; margin-left: 10px;">${{ "%.2f"|format(gasto_tdc['monto']) }}</span>
                  <br>
                  <small style="color: #94a3b8;">Corte: {{ gasto_tdc['fecha'] }}</small>
                </div>
                <a
                  href="/borrar_gasto_tdc/{{ gasto_tdc['id'] }}"
                  class="btn-delete"
                  style="padding: 5px 10px; text-decoration: none; border-radius: 5px; font-size: 0.9em;"
                  onclick="return confirm('¬øBorrar este cargo?')"
                >
                  üóëÔ∏è
                </a>
              </div>

              <!-- Si es el √∫ltimo elemento, cerrar el grupo -->
              {% if loop.last %}
                <div style="padding: 8px; background: rgba(156, 39, 176, 0.15); border: 1px solid rgba(156, 39, 176, 0.3); border-top: none; margin-top: -1px; border-radius: 0 0 5px 5px; font-weight: bold; color: #9c27b0;">
                  Total a pagar: ${{ "%.2f"|format(tarjeta_total.valor) }}
                </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          {% else %}
          <p style="color: #94a3b8">No hay pagos pendientes de tarjeta.</p>
          {% endif %}
        </div>
      </div>

      <!-- PR√âSTAMOS -->
      <div class="section">
        <h2>üí≥ Pr√©stamos</h2>
        {% if prestamos %}
        <table>
          <tr>
            <th>Nombre</th>
            <th>Mensualidad</th>
            <th>D√≠a de Pago</th>
            <th>Vigencia</th>
            <th>Acciones</th>
          </tr>
          {% for prestamo in prestamos %}
          <tr>
            <td>{{ prestamo['nombre'] }}</td>
            <td>${{ "%.2f"|format(prestamo['monto_mensual']) }}</td>
            <td>D√≠a {{ prestamo['dia_pago'] }}</td>
            <td>{{ prestamo['fecha_inicio'] }} - {{ prestamo['fecha_fin'] }}</td>
            <td>
              <a
                href="/desactivar_prestamo/{{ prestamo['id'] }}"
                class="btn-delete"
                style="
                  background: #d97706;
                  color: #f1f5f9;
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øLiquidaste este pr√©stamo?')"
              >
                üí∞ Liquidar
              </a>
              <a
                href="/borrar_prestamo/{{ prestamo['id'] }}"
                class="btn-delete"
                style="
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øSeguro que quieres BORRAR este pr√©stamo?')"
              >
                üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <p>
          No hay pr√©stamos activos.
          <button
            class="btn-principal"
            onclick="abrirRegistroPrestamo()"
            style="display: inline-block; padding: 10px 20px; margin-left: 10px"
          >
            ‚ûï Agregar Pr√©stamo
          </button>
        </p>
        {% endif %}
      </div>

      <!-- TARJETAS DE CR√âDITO -->
      <div class="section">
        <h2>üí≥ Tarjetas de Cr√©dito</h2>
        {% if tarjetas %}
        <table>
          <tr>
            <th>Nombre</th>
            <th>Fecha Corte</th>
            <th>Fecha Pago</th>
            <th>L√≠mite</th>
            <th>Acciones</th>
          </tr>
          {% for tarjeta in tarjetas %}
          <tr>
            <td>{{ tarjeta['nombre'] }}</td>
            <td>D√≠a {{ tarjeta['fecha_corte'] }}</td>
            <td>D√≠a {{ tarjeta['fecha_pago_estimada'] }}</td>
            <td>${{ "%.2f"|format(tarjeta['limite_credito']) }}</td>
            <td>
              <button
                class="btn-principal"
                onclick="abrirGastosTDC({{ tarjeta['id'] }}, '{{ tarjeta['nombre'] }}')"
                style="
                  background: #3b82f6;
                  padding: 5px 10px;
                  font-size: 0.9em;
                  margin-right: 5px;
                "
              >
                üìù Ver Gastos
              </button>
              <a
                href="/desactivar_tarjeta/{{ tarjeta['id'] }}"
                class="btn-delete"
                style="
                  background: #d97706;
                  color: #f1f5f9;
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øDesactivar esta tarjeta?')"
              >
                ‚è∏Ô∏è Desactivar
              </a>
              <a
                href="/borrar_tarjeta/{{ tarjeta['id'] }}"
                class="btn-delete"
                style="
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øSeguro que quieres BORRAR esta tarjeta y todos sus gastos?')"
              >
                üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <p>
          No hay tarjetas de cr√©dito registradas.
          <button
            class="btn-principal"
            onclick="abrirRegistroTarjeta()"
            style="display: inline-block; padding: 10px 20px; margin-left: 10px"
          >
            ‚ûï Agregar Tarjeta
          </button>
        </p>
        {% endif %}
      </div>

      <!-- INGRESOS RECURRENTES -->
      <div class="section">
        <h2>üí∞ Ingresos Recurrentes (Quincenas/Nomina)</h2>
        {% if ingresos_recurrentes %}
        <table>
          <tr>
            <th>Nombre</th>
            <th>Monto</th>
            <th>D√≠a de Pago</th>
            <th>Vigencia</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
          {% for ing in ingresos_recurrentes %}
          <tr>
            <td>{{ ing[1] }}</td>
            <td style="color: #4caf50; font-weight: bold">
              ${{ "%.2f"|format(ing[2]) }}
            </td>
            <td>D√≠a {{ ing[3] }}</td>
            <td>{{ ing[4] }} - {{ ing[5] }}</td>
            <td>
              {% if ing[6] == 1 %}‚úÖ Activo{% else %}‚è∏Ô∏è Inactivo{% endif %}
            </td>
            <td>
              {% if ing[6] == 1 %}
              <a
                href="/desactivar_ingreso_recurrente/{{ ing[0] }}"
                class="btn-delete"
                style="
                  background: #d97706;
                  color: #f1f5f9;
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øDesactivar este ingreso?')"
              >
                ‚è∏Ô∏è Desactivar
              </a>
              {% endif %}
              <a
                href="/borrar_ingreso_recurrente/{{ ing[0] }}"
                class="btn-delete"
                style="
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øSeguro que quieres BORRAR este ingreso recurrente?')"
              >
                üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <p>
          No hay ingresos recurrentes configurados.
          <button
            class="btn-principal"
            onclick="abrirIngresoRecurrente()"
            style="
              display: inline-block;
              padding: 10px 20px;
              margin-left: 10px;
              background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
              color: white;
            "
          >
            ‚ûï Agregar Ingreso Recurrente
          </button>
        </p>
        <small style="color: #94a3b8; display: block; margin-top: 10px">
          üí° Aqu√≠ agregas tu n√≥mina quincenal/mensual. Ejemplo: "Quincena d√≠a
          10" - $10,000
        </small>
        {% endif %}
      </div>

      <!-- COMPRAS MSI -->
      <div class="section">
        <h2>üõçÔ∏è Compras en MSI</h2>
        {% if msis %}
        <table>
          <tr>
            <th>Producto</th>
            <th>Total</th>
            <th>Mensualidad</th>
            <th>Meses Restantes</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
          {% for msi in msis %}
          <tr>
            <td>{{ msi[1] }}</td>
            <td>${{ "%.2f"|format(msi[2]) }}</td>
            <td>${{ "%.2f"|format(msi[4]) }}</td>
            <td>{{ msi[6] }} de {{ msi[3] }}</td>
            <td>
              {% if msi[7] == 1 %}‚úÖ Activo{% else %}‚è∏Ô∏è Liquidado{% endif %}
            </td>
            <td>
              {% if msi[7] == 1 %}
              <button
                class="btn-delete"
                style="
                  background: #17a2b8;
                  padding: 5px 10px;
                  border: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                  cursor: pointer;
                  color: white;
                  margin-right: 5px;
                "
                onclick="abrirPagoAnticipado({{ msi[0] }}, '{{ msi[1] }}', {{ msi[6] }})"
              >
                üíµ Pago Anticipado
              </button>
              <a
                href="/desactivar_msi/{{ msi[0] }}"
                class="btn-delete"
                style="
                  background: #d97706;
                  color: #f1f5f9;
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                  margin-right: 5px;
                "
                onclick="return confirm('¬øLiquidaste completamente esta compra?')"
              >
                üí∞ Liquidar
              </a>
              {% endif %}
              <a
                href="/borrar_msi/{{ msi[0] }}"
                class="btn-delete"
                style="
                  padding: 5px 10px;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.9em;
                "
                onclick="return confirm('¬øSeguro que quieres BORRAR esta compra?')"
              >
                üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <p>No hay compras en MSI activas.</p>
        {% endif %}
      </div>
    </div>

    <!-- BOT√ìN HISTORIAL DE SIMULACIONES -->
    <div style="margin-top: 20px; text-align: center;">
      <button onclick="abrirHistorial()" class="btn-submit" style="background: var(--primary-gradient); padding: 15px 30px; font-size: 1.1em;">
        üìã VER HISTORIAL DE SIMULACIONES
      </button>
    </div>

    <!-- MODAL SIMULADOR -->
    <div id="modalSimulador" class="modal">
      <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <span class="close-modal" onclick="cerrarSimulador()">&times;</span>
        <h2>üõí Simulador de Compra</h2>

        <div class="form-group">
          <label>Producto:</label>
          <input type="text" id="productoSim" placeholder="Ej: Laptop Lenovo" />
        </div>

        <div class="form-group">
          <label>Precio:</label>
          <input type="number" id="precioSim" placeholder="35000" />
        </div>

        <div class="form-group">
          <label>Meses Sin Intereses:</label>
          <select id="mesesSim">
            <option value="3">3 MSI</option>
            <option value="6">6 MSI</option>
            <option value="9">9 MSI</option>
            <option value="12">12 MSI</option>
            <option value="18">18 MSI</option>
            <option value="24">24 MSI</option>
          </select>
        </div>

        <button class="btn-submit" onclick="simularCompra()">
          CALCULAR IMPACTO
        </button>

        <div id="resultadoSim" class="resultado-simulacion"></div>
      </div>
    </div>

    <!-- MODAL PR√âSTAMO (SIMPLIFICADO) -->
    <div id="modalCredito" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <span class="close-modal" onclick="cerrarCredito()">&times;</span>
        <h2>üí≥ Agregar Pr√©stamo</h2>

        <form action="/agregar_prestamo" method="POST">
          <div class="form-group">
            <label>Nombre del Pr√©stamo:</label>
            <input
              type="text"
              name="nombre"
              placeholder="Pr√©stamo Personal, Cr√©dito Automotriz, etc."
              required
            />
          </div>

          <div class="form-group">
            <label>Monto Mensual:</label>
            <input
              type="number"
              step="0.01"
              name="monto_mensual"
              placeholder="2500.00"
              required
            />
          </div>

          <div class="form-group">
            <label>D√≠a de Pago (1-31):</label>
            <input
              type="number"
              name="dia_pago"
              min="1"
              max="31"
              placeholder="15"
              required
            />
            <small style="color: #94a3b8">D√≠a del mes que debes hacer el pago</small>
          </div>

          <div class="form-group">
            <label>Alertarme X d√≠as antes:</label>
            <input
              type="number"
              name="dias_alerta"
              min="1"
              max="30"
              value="10"
            />
            <small style="color: #94a3b8">D√≠as de anticipaci√≥n para la alerta</small>
          </div>

          <h3 style="color: #667eea; margin: 20px 0 15px 0; font-size: 1.1em">
            üìÜ Vigencia
          </h3>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
            <div class="form-group">
              <label>Fecha Inicio:</label>
              <div id="fecha-inicio-credito"></div>
              <small style="color: #94a3b8">Desde cu√°ndo aplica este pr√©stamo</small>
            </div>

            <div class="form-group">
              <label>Fecha Fin:</label>
              <div id="fecha-fin-credito"></div>
              <small style="color: #94a3b8">Hasta cu√°ndo estar√°s pagando</small>
            </div>
          </div>

          <button type="submit" class="btn-submit">AGREGAR PR√âSTAMO</button>
        </form>
      </div>
    </div>

    <!-- MODAL PR√âSTAMO -->
    <div id="modalPrestamo" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <span class="close-modal" onclick="cerrarPrestamo()">&times;</span>
        <h2>üí≥ Agregar Pr√©stamo</h2>

        <form action="/agregar_prestamo" method="POST">
          <div class="form-group">
            <label>Nombre del Pr√©stamo:</label>
            <input
              type="text"
              name="nombre"
              placeholder="Pr√©stamo Personal, Cr√©dito Automotriz, etc."
              required
            />
          </div>

          <div class="form-group">
            <label>Monto Mensual:</label>
            <input
              type="number"
              step="0.01"
              name="monto_mensual"
              placeholder="2500.00"
              required
            />
          </div>

          <div class="form-group">
            <label>D√≠a de Pago (1-31):</label>
            <input
              type="number"
              name="dia_pago"
              min="1"
              max="31"
              placeholder="15"
              required
            />
          </div>

          <div class="form-group">
            <label>Alertarme X d√≠as antes:</label>
            <input
              type="number"
              name="dias_alerta"
              min="1"
              max="30"
              value="10"
            />
          </div>

          <h3 style="color: #667eea; margin: 20px 0 15px 0; font-size: 1.1em">
            üìÜ Vigencia
          </h3>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
            <div class="form-group">
              <label>Fecha Inicio:</label>
              <div id="fecha-inicio-prestamo"></div>
            </div>

            <div class="form-group">
              <label>Fecha Fin:</label>
              <div id="fecha-fin-prestamo"></div>
            </div>
          </div>

          <button type="submit" class="btn-submit">AGREGAR PR√âSTAMO</button>
        </form>
      </div>
    </div>

    <!-- MODAL TARJETA DE CR√âDITO -->
    <div id="modalTarjeta" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <span class="close-modal" onclick="cerrarTarjeta()">&times;</span>
        <h2>üí≥ Agregar Tarjeta de Cr√©dito</h2>

        <form action="/agregar_tarjeta" method="POST">
          <div class="form-group">
            <label>Nombre de la Tarjeta:</label>
            <input
              type="text"
              name="nombre"
              placeholder="BBVA Azul, Liverpool, Nu, etc."
              required
            />
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
            <div class="form-group">
              <label>Fecha de Corte (D√≠a):</label>
              <input
                type="number"
                name="fecha_corte"
                min="1"
                max="31"
                placeholder="17"
                required
              />
              <small style="color: #94a3b8">D√≠a que cierra el estado de cuenta</small>
            </div>

            <div class="form-group">
              <label>Fecha de Pago Estimada (D√≠a):</label>
              <input
                type="number"
                name="fecha_pago_estimada"
                min="1"
                max="31"
                placeholder="3"
                required
              />
              <small style="color: #94a3b8">D√≠a aproximado de pago</small>
            </div>
          </div>

          <div class="form-group">
            <label>L√≠mite de Cr√©dito (opcional):</label>
            <input
              type="number"
              step="0.01"
              name="limite_credito"
              placeholder="50000.00"
            />
          </div>

          <button type="submit" class="btn-submit">AGREGAR TARJETA</button>
        </form>
      </div>
    </div>

    <!-- MODAL GASTOS TDC -->
    <div id="modalGastosTDC" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <span class="close-modal" onclick="cerrarGastosTDC()">&times;</span>
        <h2 id="tituloGastosTDC">üí≥ Gastos de Tarjeta</h2>

        <!-- Formulario para agregar gasto -->
        <div style="background: rgba(59, 130, 246, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px">
          <h3 style="color: #3b82f6; margin-top: 0">‚ûï Agregar Nuevo Gasto</h3>
          <form action="/agregar_gasto_tdc" method="POST">
            <input type="hidden" name="tarjeta_id" id="tarjeta_id_input" />

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
              <div class="form-group">
                <label>Fecha:</label>
                <input type="date" name="fecha" required />
              </div>

              <div class="form-group">
                <label>Monto:</label>
                <input type="number" step="0.01" name="monto" placeholder="1500.00" required />
              </div>
            </div>

            <div class="form-group">
              <label>Concepto:</label>
              <input type="text" name="concepto" placeholder="Compra en Amazon" required />
            </div>

            <div class="form-group">
              <label>Categor√≠a:</label>
              <select name="categoria_id">
                <option value="">Sin categor√≠a</option>
                {% for cat in categorias %}
                  {% if cat['tipo'] == 'gasto' %}
                  <option value="{{ cat['id'] }}">{{ cat['nombre'] }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="es_msi_tdc" name="es_msi" value="1" onchange="toggleMSITDC()" />
                ¬øEs a Meses Sin Intereses (MSI)?
              </label>
            </div>

            <div id="msiFieldsTDC" style="display: none">
              <div class="form-group">
                <label>Meses:</label>
                <select name="meses_msi">
                  <option value="3">3 meses</option>
                  <option value="6">6 meses</option>
                  <option value="9">9 meses</option>
                  <option value="12">12 meses</option>
                  <option value="18">18 meses</option>
                  <option value="24">24 meses</option>
                </select>
              </div>
            </div>

            <input type="hidden" name="tipo" id="tipo_gasto_tdc" value="corriente" />

            <button type="submit" class="btn-submit">AGREGAR GASTO</button>
          </form>
        </div>

        <!-- Lista de gastos -->
        <div id="listaGastosTDC"></div>
      </div>
    </div>

    <script>
      function abrirRegistroCredito() {
        document.getElementById("modalCredito").style.display = "block";
        setTimeout(() => {
          createDateInput("fecha-inicio-credito", "fecha_inicio", true);
          createDateInput("fecha-fin-credito", "fecha_fin", true);
        }, 100);
      }
    </script>

    <!-- MODAL PAGO ANTICIPADO MSI -->
    <div id="modalPagoAnticipado" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarPagoAnticipado()"
          >&times;</span
        >
        <h2>üíµ Pago Anticipado</h2>

        <p id="infoPagoAnticipado"></p>

        <form id="formPagoAnticipado" method="POST">
          <div class="form-group">
            <label>¬øCu√°ntos meses adelantaste?</label>
            <input
              type="number"
              name="meses_pagados"
              min="1"
              id="mesesPagados"
              required
            />
            <small style="color: #94a3b8"
              >Ej: Si pagaste 3 mensualidades adelantadas, pon 3</small
            >
          </div>

          <button type="submit" class="btn-submit">REGISTRAR PAGO</button>
        </form>
      </div>
    </div>

    <!-- MODAL REGISTRAR GASTO -->
    <div id="modalGasto" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <span class="close-modal" onclick="cerrarGasto()">&times;</span>
        <h2>üí≥ Registrar Gasto</h2>

        <form action="/agregar_gasto" method="POST" id="formGasto" onsubmit="return validarFormularioGasto()">
          <!-- CAMPO 1: Tipo de Pago (ahora es el primero) -->
          <div class="form-group">
            <label>Tipo de Pago:</label>
            <select name="tipo" id="tipoPagoGasto" required onchange="cambiarTipoPagoGasto()">
              <option value="efectivo">üíµ Efectivo/Transferencia/D√©bito</option>
              <option value="tarjeta">üí≥ Tarjeta de Cr√©dito</option>
            </select>
          </div>

          <!-- CAMPOS PARA EFECTIVO/TRANSFERENCIA -->
          <div id="camposEfectivo">
            <div class="form-group">
              <label>Fecha del Pago:</label>
              <div id="fecha-gasto"></div>
              <small style="color: #94a3b8; display: block; margin-top: 5px;">
                Selecciona la fecha del pago (hoy o fecha futura planeada)
              </small>
            </div>
          </div>

          <!-- CAMPOS PARA TARJETA DE CR√âDITO -->
          <div id="camposTarjeta" style="display: none;">
            <div class="form-group">
              <label>Selecciona la Tarjeta:</label>
              <select name="tarjeta_id" id="tarjetaGastoSelect" onchange="mostrarOpcionesCorte()">
                <option value="">Selecciona una tarjeta...</option>
                {% for tarjeta in tarjetas %}
                <option value="{{ tarjeta['id'] }}"
                        data-fecha-corte="{{ tarjeta['fecha_corte'] }}"
                        data-fecha-pago="{{ tarjeta['fecha_pago'] }}">
                  {{ tarjeta['nombre'] }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group" id="opcionesCorte" style="display: none;">
              <label>¬øEn qu√© corte aparece este gasto?</label>
              <select id="seleccionCorte" onchange="actualizarFechaCorte()">
                <option value="proximo">üìÖ Pr√≥ximo corte</option>
                <option value="anterior">‚èÆÔ∏è Corte anterior (lo olvid√© registrar)</option>
              </select>
              <small style="color: #94a3b8; display: block; margin-top: 5px;" id="infoFechaCorte">
                Se registrar√° en el pr√≥ximo corte
              </small>
            </div>

            <input type="hidden" name="fecha" id="fechaTarjetaHidden" />

            <div class="form-group" style="margin-top: 20px">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" name="es_msi" value="1" id="checkboxMSI" onchange="toggleMSI(this)">
                <span>üí≥ Es compra a Meses Sin Intereses (MSI)</span>
              </label>
            </div>

            <div id="msiFields" style="display: none; margin-top: 15px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">

              <!-- Selector: ¬øQu√© dato tienes? -->
              <div class="form-group">
                <label style="font-weight: bold; color: #6366f1;">¬øQu√© informaci√≥n tienes?</label>
                <select id="tipoCalculoMSI" onchange="cambiarTipoCalculoMSI()" style="width: 100%;">
                  <option value="tengo_mensualidad">üìä Tengo la mensualidad (del estado de cuenta)</option>
                  <option value="tengo_total">üõí Tengo el precio total (compra nueva)</option>
                </select>
              </div>

              <!-- OPCI√ìN 1: Tengo la mensualidad -->
              <div id="opcionMensualidad">
                <div class="form-group">
                  <label>Mensualidad (pago mensual):</label>
                  <input
                    type="number"
                    step="0.01"
                    id="mensualidadMSI"
                    min="0.01"
                    placeholder="Ej: 2250.00"
                    style="width: 100%;"
                    oninput="calcularDesdeMensualidad()"
                  />
                  <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Monto que pagas cada mes (como aparece en tu estado de cuenta)
                  </small>
                </div>

                <div class="form-group">
                  <label>Meses restantes (1-72):</label>
                  <input
                    type="number"
                    name="meses"
                    id="mesesRestantesMSI"
                    min="1"
                    max="72"
                    placeholder="Ej: 4"
                    style="width: 100%;"
                    oninput="calcularDesdeMensualidad()"
                  />
                  <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    ¬øCu√°ntas mensualidades te faltan por pagar?
                  </small>
                </div>

                <div class="form-group" style="background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 5px; border: 1px solid rgba(34, 197, 94, 0.3);">
                  <label style="color: #22c55e; font-weight: bold;">üìä Total calculado:</label>
                  <div id="totalCalculadoDesdeMensualidad" style="font-size: 1.3em; color: #22c55e; font-weight: bold;">
                    $0.00
                  </div>
                  <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Mensualidad √ó Meses restantes = Total
                  </small>
                </div>
              </div>

              <!-- OPCI√ìN 2: Tengo el precio total -->
              <div id="opcionTotal" style="display: none;">
                <div class="form-group">
                  <label>Precio total de la compra:</label>
                  <input
                    type="number"
                    step="0.01"
                    id="totalCompraMSI"
                    min="0.01"
                    placeholder="Ej: 9000.00"
                    style="width: 100%;"
                    oninput="calcularDesdeTotal()"
                  />
                  <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Precio total de la compra nueva
                  </small>
                </div>

                <div class="form-group">
                  <label>N√∫mero de meses (1-72):</label>
                  <input
                    type="number"
                    name="meses"
                    id="mesesTotalesMSI"
                    min="1"
                    max="72"
                    placeholder="Ej: 12"
                    style="width: 100%;"
                    oninput="calcularDesdeTotal()"
                  />
                  <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    ¬øA cu√°ntos meses la compraste?
                  </small>
                </div>

                <div class="form-group" style="background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 5px; border: 1px solid rgba(34, 197, 94, 0.3);">
                  <label style="color: #22c55e; font-weight: bold;">üìä Mensualidad calculada:</label>
                  <div id="mensualidadCalculadaDesdeTotal" style="font-size: 1.3em; color: #22c55e; font-weight: bold;">
                    $0.00
                  </div>
                  <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    Total √∑ Meses = Mensualidad
                  </small>
                </div>
              </div>

              <input type="hidden" name="fecha_primera_msi" id="fechaPrimeraMSIHidden" />
            </div>
          </div>

          <!-- CAMPOS COMUNES PARA AMBOS TIPOS -->
          <div class="form-group">
            <label>Concepto/Nombre:</label>
            <input
              type="text"
              name="nombre"
              placeholder="Comida, Gasolina, Uber..."
              required
            />
          </div>

          <div class="form-group" id="campoMonto">
            <label>Monto:</label>
            <input
              type="number"
              step="0.01"
              name="monto"
              id="montoGasto"
              placeholder="500.00"
              required
              min="0.01"
            />
            <small style="color: #94a3b8; display: block; margin-top: 5px;" id="ayudaMonto">
              Para gastos normales, ingresa el monto total
            </small>
          </div>

          <div class="form-group">
            <label>Categor√≠a:</label>
            <select name="categoria_id">
              <option value="">Sin categor√≠a</option>
              {% for cat in categorias %}
                {% if cat['tipo'] == 'gasto' %}
                <option value="{{ cat['id'] }}">{{ cat['nombre'] }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn-submit" style="margin-top: 20px;">
            ‚ûï REGISTRAR GASTO
          </button>
        </form>
      </div>
    </div>

    <!-- MODAL PRIMERA VEZ (Configurar Balance Inicial) -->
    <div
      id="modalPrimeraVez"
      class="modal"
      style="display: {% if primera_vez == 1 %}block{% else %}none{% endif %};"
    >
      <div class="modal-content" style="max-width: 500px">
        <h2 style="color: #667eea; text-align: center">
          ¬°Bienvenido a FinanzApp! üéâ
        </h2>

        <p style="text-align: center; color: #94a3b8; margin: 20px 0">
          Para empezar, necesitamos saber cu√°nto dinero tienes disponible ahora
          mismo.
        </p>

        <form action="/configurar_balance_inicial" method="POST">
          <div class="form-group">
            <label style="font-size: 1.2em"
              >üíµ ¬øCu√°nto dinero tienes ahora?</label
            >
            <input
              type="number"
              step="0.01"
              name="balance"
              placeholder="48188.37"
              required
              style="font-size: 1.5em; text-align: center; padding: 15px"
              min="0"
              max="99999999"
            />
            <small
              style="
                color: #94a3b8;
                display: block;
                text-align: center;
                margin-top: 10px;
              "
            >
              Esto es tu punto de partida. Puedes cambiarlo despu√©s.
            </small>
          </div>

          <button
            type="submit"
            class="btn-submit"
            style="font-size: 1.2em; padding: 15px"
          >
            üöÄ EMPEZAR
          </button>
        </form>
      </div>
    </div>

    <!-- MODAL EDITAR BALANCE INICIAL -->
    <div id="modalEditarBalance" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarEditarBalance()">&times;</span>
        <h2>‚úèÔ∏è Editar Balance Inicial</h2>

        <p style="color: #94a3b8">
          Balance actual: <strong>${{ "%.2f"|format(balance_inicial) }}</strong>
        </p>

        <form action="/editar_balance_inicial" method="POST">
          <div class="form-group">
            <label>Nuevo Balance Inicial:</label>
            <input
              type="number"
              step="0.01"
              name="balance"
              value="{{ balance_inicial }}"
              required
            />
            <small style="color: #94a3b8">
              Esto solo cambia tu punto de partida, no afecta ingresos ni gastos
              registrados.
            </small>
          </div>

          <button type="submit" class="btn-submit">ACTUALIZAR</button>
        </form>
      </div>
    </div>

    <!-- MODAL CONFIGURAR VISTA QUINCENAL -->
    <div id="modalVistaQuincenal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <span class="close-modal" onclick="cerrarVistaQuincenal()">&times;</span>
        <h2>üìä Configurar Vista Quincenal</h2>

        <p style="color: #94a3b8; margin-bottom: 20px;">
          La vista quincenal te permite ver tu proyecci√≥n financiera por quincenas en lugar de meses,
          ideal si recibes tu n√≥mina cada 15 d√≠as.
        </p>

        <form action="/actualizar_vista_quincenal" method="POST">
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input
                type="checkbox"
                name="vista_quincenal"
                id="checkVistaQuincenal"
                value="1"
                {% if vista_quincenal == 1 %}checked{% endif %}
                onchange="toggleCamposQuincenales()"
                style="width: auto; cursor: pointer;"
              />
              <span style="font-weight: bold;">Activar vista quincenal</span>
            </label>
          </div>

          <div id="camposQuincenales" style="{% if vista_quincenal != 1 %}display: none;{% endif %}">
            <div class="form-group">
              <label>Primera fecha de pago del mes (d√≠a):</label>
              <input
                type="number"
                name="fecha_pago_1"
                id="fechaPago1"
                min="1"
                max="31"
                value="{{ fecha_pago_1 if fecha_pago_1 else 15 }}"
                required
              />
              <small style="color: #94a3b8">
                Ejemplo: Si te pagan el d√≠a 10, ingresa 10
              </small>
            </div>

            <div class="form-group">
              <label>Segunda fecha de pago del mes (d√≠a):</label>
              <input
                type="number"
                name="fecha_pago_2"
                id="fechaPago2"
                min="1"
                max="31"
                value="{{ fecha_pago_2 if fecha_pago_2 else 30 }}"
                required
              />
              <small style="color: #94a3b8">
                Ejemplo: Si te pagan el d√≠a 25, ingresa 25
              </small>
            </div>

            <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1;">
              <p style="margin: 0; color: #94a3b8; font-size: 0.9em;">
                <strong>üìå Ejemplo:</strong><br>
                Si tus fechas de pago son <strong>10</strong> y <strong>25</strong>:<br>
                ‚Ä¢ Quincena 1: Del 26 al 10 (pago d√≠a 10)<br>
                ‚Ä¢ Quincena 2: Del 11 al 25 (pago d√≠a 25)
              </p>
            </div>
          </div>

          <button type="submit" class="btn-submit">GUARDAR CONFIGURACI√ìN</button>
        </form>
      </div>
    </div>

    <!-- MODAL REGISTRAR INGRESO -->
    <div id="modalRegistroIngreso" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <span class="close-modal" onclick="cerrarRegistroIngreso()">&times;</span>
        <h2>üíµ Registrar Ingreso</h2>

        <form action="/agregar_ingreso" method="POST">
          <!-- Campo oculto con fecha actual -->
          <input type="hidden" name="fecha" id="fecha-ingreso-actual" />

          <div class="form-group">
            <label>Concepto:</label>
            <input
              type="text"
              name="concepto"
              placeholder="Venta, Regalo, Bono, etc."
              required
            />
          </div>

          <div class="form-group">
            <label>Monto:</label>
            <input
              type="number"
              step="0.01"
              name="monto"
              placeholder="1000.00"
              required
            />
          </div>

          <div class="form-group">
            <label>Categor√≠a (opcional):</label>
            <select name="categoria_id">
              <option value="">Sin categor√≠a</option>
              {% for cat in categorias %}
              {% if cat['tipo'] == 'ingreso' %}
              <option value="{{ cat['id'] }}">{{ cat['nombre'] }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn-submit">REGISTRAR INGRESO</button>
        </form>
      </div>
    </div>

    <!-- MODAL INGRESO RECURRENTE -->
    <div id="modalIngresoRecurrente" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="cerrarIngresoRecurrente()"
          >&times;</span
        >
        <h2>üí∞ Agregar Ingreso Recurrente</h2>

        <p style="color: #94a3b8; margin-bottom: 20px">
          Configura ingresos que se repiten (n√≥mina, aguinaldo, bonos, etc.). Se sumar√°n autom√°ticamente en la proyecci√≥n seg√∫n su frecuencia.
        </p>

        <form action="/agregar_ingreso_recurrente" method="POST">
          <div class="form-group">
            <label>Nombre:</label>
            <input
              type="text"
              name="nombre"
              placeholder="Quincena d√≠a 10"
              required
            />
            <small style="color: #94a3b8"
              >Ej: "Quincena d√≠a 10", "N√≥mina mensual", etc.</small
            >
          </div>

          <div class="form-group">
            <label>Monto:</label>
            <input
              type="number"
              step="0.01"
              name="monto"
              placeholder="10000.00"
              required
            />
          </div>

          <div class="form-group">
            <label>Frecuencia:</label>
            <select name="frecuencia" id="frecuencia_select" onchange="toggleMesEspecifico()" required>
              <option value="semanal">üìÖ Semanal (cada semana)</option>
              <option value="quincenal">üìÜ Quincenal (cada 15 d√≠as)</option>
              <option value="mensual" selected>üìÖ Mensual (cada mes)</option>
              <option value="bimestral">üìÖ Bimestral (cada 2 meses)</option>
              <option value="trimestral">üìÖ Trimestral (cada 3 meses)</option>
              <option value="semestral">üìÖ Semestral (cada 6 meses)</option>
              <option value="anual">üìÖ Anual (cada a√±o)</option>
            </select>
            <small style="color: #94a3b8">¬øCon qu√© frecuencia recibes este ingreso?</small>
          </div>

          <div class="form-group" id="mes_especifico_group" style="display: none;">
            <label>Mes Espec√≠fico (para ingreso anual):</label>
            <select name="mes_especifico">
              <option value="">-- Seleccionar mes --</option>
              <option value="1">Enero</option>
              <option value="2">Febrero</option>
              <option value="3">Marzo</option>
              <option value="4">Abril</option>
              <option value="5">Mayo</option>
              <option value="6">Junio</option>
              <option value="7">Julio</option>
              <option value="8">Agosto</option>
              <option value="9">Septiembre</option>
              <option value="10">Octubre</option>
              <option value="11">Noviembre</option>
              <option value="12">Diciembre</option>
            </select>
            <small style="color: #94a3b8">Ej: Aguinaldo en Diciembre, Bono en Junio, etc.</small>
          </div>

          <div class="form-group">
            <label>D√≠a de Pago:</label>
            <input
              type="number"
              name="dia_pago"
              min="1"
              max="31"
              placeholder="10"
              required
            />
            <small style="color: #94a3b8"
              >El d√≠a que recibes este ingreso (del mes o a√±o seg√∫n frecuencia)</small
            >
          </div>

          <div class="form-group">
            <label>Fecha Inicio: <span style="color: #dc3545;">*</span></label>
            <div id="fecha-inicio-ingreso-rec"></div>
            <small style="color: #94a3b8">Desde cu√°ndo empieza a aplicar este ingreso</small>
          </div>

          <div class="form-group">
            <label>Fecha Fin (opcional):</label>
            <div id="fecha-fin-ingreso-rec"></div>
            <small style="color: #94a3b8">D√©jalo vac√≠o si es indefinido (seguir√° para siempre)</small>
          </div>

          <button type="submit" class="btn-submit">
            AGREGAR INGRESO RECURRENTE
          </button>
        </form>

        <div
          style="
            background: rgba(29, 78, 216, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #bfdbfe;
            margin-top: 20px;
          "
        >
          <strong>üí° Tips:</strong>
          <ul style="margin: 10px 0 0 20px; font-size: 0.9em;">
            <li><strong>Quincenas:</strong> Selecciona "Quincenal" y agrega dos ingresos si recibes en dos fechas distintas (d√≠a 10 y 25)</li>
            <li style="margin-top: 10px;"><strong>Aguinaldo/Bonos:</strong> Selecciona "Anual" y elige el mes espec√≠fico (ej: Diciembre para aguinaldo)</li>
            <li style="margin-top: 5px;"><strong>Fecha Inicio:</strong> Desde cu√°ndo empieza a aplicar este ingreso</li>
            <li style="margin-top: 5px;"><strong>Fecha Fin:</strong> D√©jala vac√≠a si es permanente. Ll√©nala solo si sabes cu√°ndo terminar√°</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- MODAL HISTORIAL DE SIMULACIONES -->
    <div id="modalHistorial" class="modal">
      <div class="modal-content" style="max-width: 95%; width: 1200px;">
        <span class="close-modal" onclick="cerrarHistorial()">&times;</span>
        <h2>üìã Historial de Simulaciones</h2>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">
          Aqu√≠ puedes ver tus simulaciones anteriores. Es √∫til para recordar qu√© compras consideraste y tomar mejores decisiones financieras.
        </p>

        {% if historial_simulaciones %}
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--primary-gradient); color: white;">
                <th style="padding: 12px; text-align: left; font-size: 0.9em;">Fecha</th>
                <th style="padding: 12px; text-align: left; font-size: 0.9em;">Producto</th>
                <th style="padding: 12px; text-align: right; font-size: 0.9em;">Precio</th>
                <th style="padding: 12px; text-align: center; font-size: 0.9em;">Meses</th>
                <th style="padding: 12px; text-align: right; font-size: 0.9em;">Mensualidad</th>
                <th style="padding: 12px; text-align: center; font-size: 0.9em;">Veredicto</th>
                <th style="padding: 12px; text-align: right; font-size: 0.9em;">Saldo M√≠nimo</th>
              </tr>
            </thead>
            <tbody>
              {% for sim in historial_simulaciones %}
              <tr style="border-bottom: 1px solid var(--card-border);">
                <td style="padding: 12px; color: var(--text-secondary); font-size: 0.85em;">
                  {{ sim['fecha_simulacion'][:16] }}
                </td>
                <td style="padding: 12px; color: var(--text-primary);">
                  {{ sim['producto'] or 'Sin nombre' }}
                </td>
                <td style="padding: 12px; text-align: right; color: var(--text-primary); font-weight: 600;">
                  ${{ "{:,.2f}".format(sim['precio_total']) }}
                </td>
                <td style="padding: 12px; text-align: center; color: var(--text-secondary);">
                  {{ sim['meses'] }} MSI
                </td>
                <td style="padding: 12px; text-align: right; color: var(--warning-text);">
                  ${{ "{:,.2f}".format(sim['mensualidad']) }}
                </td>
                <td style="padding: 12px; text-align: center;">
                  <span style="
                    display: inline-block;
                    padding: 4px 12px;
                    border-radius: 12px;
                    font-size: 0.85em;
                    font-weight: 600;
                    {% if 'SI' in sim['veredicto'] %}
                      background: var(--success-bg);
                      color: var(--success-text);
                      border: 1px solid var(--success-border);
                    {% elif 'CUIDADO' in sim['veredicto'] %}
                      background: var(--warning-bg);
                      color: var(--warning-text);
                      border: 1px solid var(--warning-border);
                    {% else %}
                      background: var(--danger-bg);
                      color: var(--danger-text);
                      border: 1px solid var(--danger-border);
                    {% endif %}
                  ">
                    {{ sim['veredicto'] }}
                  </span>
                </td>
                <td style="padding: 12px; text-align: right; color: {{ 'var(--danger-text)' if sim['saldo_minimo'] < 0 else 'var(--text-primary)' }}; font-weight: 600;">
                  ${{ "{:,.2f}".format(sim['saldo_minimo']) }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.8em; margin-top: 12px; font-style: italic;">
          üí≠ Tip: Revisa tus simulaciones pasadas para ver patrones en tus decisiones de compra.
        </p>
        {% else %}
        <div style="text-align: center; padding: 40px; background: rgba(99, 102, 241, 0.05); border-radius: 12px; border: 2px dashed rgba(99, 102, 241, 0.3);">
          <p style="color: var(--text-secondary); font-size: 1.1em;">
            üìã No has simulado ninguna compra a√∫n
          </p>
          <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">
            Usa el bot√≥n "üõí SIMULAR COMPRA" para proyectar el impacto de tus futuras compras
          </p>
        </div>
        {% endif %}
      </div>
    </div>

    <script>
      // ========== FILTRO DE PERIODO ==========
      let periodoActual = 'todo'; // 'todo' o 'mes'
      const datosOriginales = {
        balanceInicial: {{ balance_inicial }},
        totalIngresos: {{ total_ingresos }},
        totalGastos: {{ total_gastos }},
        saldoActual: {{ balance }}
      };

      async function cambiarPeriodo(periodo) {
        periodoActual = periodo;

        // Actualizar estilos de botones
        const btnTodo = document.getElementById('btnTodoTiempo');
        const btnMes = document.getElementById('btnEsteMes');

        if (periodo === 'todo') {
          btnTodo.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          btnTodo.style.color = 'white';
          btnTodo.style.border = 'none';
          btnMes.style.background = 'transparent';
          btnMes.style.color = '#cbd5e1';
          btnMes.style.border = '1px solid rgba(255,255,255,0.2)';

          // Mostrar datos de todo el tiempo
          document.getElementById('labelPeriodoInicial').textContent = '(Al comenzar a usar la app)';
          document.getElementById('labelPeriodoMovimientos').textContent = '(Hasta hoy)';
          document.getElementById('labelPeriodoActual').textContent = '(A d√≠a de hoy)';

          document.getElementById('saldoInicial').textContent = '$' + datosOriginales.balanceInicial.toFixed(2);
          document.getElementById('totalIngresos').textContent = '+$' + datosOriginales.totalIngresos.toFixed(2);
          document.getElementById('totalGastos').textContent = '-$' + datosOriginales.totalGastos.toFixed(2);
          document.getElementById('saldoActual').textContent = '$' + datosOriginales.saldoActual.toFixed(2);
        } else {
          btnMes.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          btnMes.style.color = 'white';
          btnMes.style.border = 'none';
          btnTodo.style.background = 'transparent';
          btnTodo.style.color = '#cbd5e1';
          btnTodo.style.border = '1px solid rgba(255,255,255,0.2)';

          // Obtener datos del mes actual desde el servidor
          try {
            const response = await fetch('/api/movimientos_mes_actual');
            const datos = await response.json();

            const nombreMes = new Date().toLocaleDateString('es-MX', { month: 'long', year: 'numeric' });

            document.getElementById('labelPeriodoInicial').textContent = `(Al 1 de ${nombreMes})`;
            document.getElementById('labelPeriodoMovimientos').textContent = '(Solo este mes)';
            document.getElementById('labelPeriodoActual').textContent = '(A d√≠a de hoy)';

            document.getElementById('saldoInicial').textContent = '$' + datos.saldo_inicio_mes.toFixed(2);
            document.getElementById('totalIngresos').textContent = '+$' + datos.ingresos_mes.toFixed(2);
            document.getElementById('totalGastos').textContent = '-$' + datos.gastos_mes.toFixed(2);
            document.getElementById('saldoActual').textContent = '$' + datos.saldo_actual.toFixed(2);
          } catch (error) {
            console.error('Error al obtener datos del mes:', error);
          }
        }
      }

      // Abrir modal de Registrar Ingreso
      function abrirRegistroIngreso() {
        document.getElementById("modalRegistroIngreso").style.display = "block";
        // Establecer fecha actual autom√°ticamente
        const hoy = new Date();
        const year = hoy.getFullYear();
        const month = String(hoy.getMonth() + 1).padStart(2, '0');
        const day = String(hoy.getDate()).padStart(2, '0');
        document.getElementById("fecha-ingreso-actual").value = `${year}-${month}-${day}`;
      }

      // Cerrar modal de Registrar Ingreso
      function cerrarRegistroIngreso() {
        document.getElementById("modalRegistroIngreso").style.display = "none";
      }

      // Inicializar componentes de fecha cuando se abra el modal
      function abrirIngresoRecurrente() {
        document.getElementById("modalIngresoRecurrente").style.display =
          "block";
        // Inicializar fechas si a√∫n no existen
        setTimeout(() => {
          createDateInput("fecha-inicio-ingreso-rec", "fecha_inicio", true);
          createDateInput("fecha-fin-ingreso-rec", "fecha_fin", false);
        }, 100);
      }

      function abrirHistorial() {
        document.getElementById("modalHistorial").style.display = "block";
      }

      function cerrarHistorial() {
        document.getElementById("modalHistorial").style.display = "none";
      }
    </script>

    <script>
      // ========== SISTEMA DE FECHAS PERSONALIZADO ==========

      function createDateInput(
        containerId,
        fieldName,
        required = false,
        defaultValue = ""
      ) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const today = new Date();
        let day = "",
          month = "",
          year = "";

        // Parsear valor por defecto si existe
        if (defaultValue) {
          const parts = defaultValue.split("-");
          if (parts.length === 3) {
            year = parts[0];
            month = parts[1];
            day = parts[2];
          }
        }

        container.innerHTML = `
                <div class="date-input-group">
                    <div class="date-field">
                        <label>D√≠a</label>
                        <input type="number" 
                               class="date-day" 
                               min="1" 
                               max="31" 
                               placeholder="DD"
                               value="${day}"
                               ${required ? "required" : ""}>
                    </div>
                    <div class="date-field">
                        <label>Mes</label>
                        <select class="date-month" ${
                          required ? "required" : ""
                        }>
                            <option value="">Selecciona</option>
                            <option value="01" ${
                              month === "01" ? "selected" : ""
                            }>Enero</option>
                            <option value="02" ${
                              month === "02" ? "selected" : ""
                            }>Febrero</option>
                            <option value="03" ${
                              month === "03" ? "selected" : ""
                            }>Marzo</option>
                            <option value="04" ${
                              month === "04" ? "selected" : ""
                            }>Abril</option>
                            <option value="05" ${
                              month === "05" ? "selected" : ""
                            }>Mayo</option>
                            <option value="06" ${
                              month === "06" ? "selected" : ""
                            }>Junio</option>
                            <option value="07" ${
                              month === "07" ? "selected" : ""
                            }>Julio</option>
                            <option value="08" ${
                              month === "08" ? "selected" : ""
                            }>Agosto</option>
                            <option value="09" ${
                              month === "09" ? "selected" : ""
                            }>Septiembre</option>
                            <option value="10" ${
                              month === "10" ? "selected" : ""
                            }>Octubre</option>
                            <option value="11" ${
                              month === "11" ? "selected" : ""
                            }>Noviembre</option>
                            <option value="12" ${
                              month === "12" ? "selected" : ""
                            }>Diciembre</option>
                        </select>
                    </div>
                    <div class="date-field">
                        <label>A√±o</label>
                        <input type="number" 
                               class="date-year" 
                               min="${today.getFullYear()}" 
                               max="9999" 
                               placeholder="AAAA"
                               value="${year}"
                               ${required ? "required" : ""}>
                    </div>
                </div>
                <input type="hidden" name="${fieldName}" class="date-hidden-value" value="${defaultValue}">
                <div class="date-error"></div>
            `;

        // Agregar validaci√≥n en tiempo real
        const dayInput = container.querySelector(".date-day");
        const monthSelect = container.querySelector(".date-month");
        const yearInput = container.querySelector(".date-year");
        const hiddenInput = container.querySelector(".date-hidden-value");
        const errorDiv = container.querySelector(".date-error");

        // Limitar a√±o a 4 d√≠gitos y validar rango
        yearInput.addEventListener("input", function () {
          // Prevenir m√°s de 4 d√≠gitos
          if (this.value.length > 4) {
            this.value = this.value.slice(0, 4);
          }

          // Validar rango si tiene 4 d√≠gitos
          if (this.value.length === 4) {
            const yearValue = parseInt(this.value);
            const currentYear = new Date().getFullYear();

            if (yearValue < currentYear) {
              this.value = currentYear.toString();
              errorDiv.textContent = `El a√±o no puede ser menor a ${currentYear}`;
              errorDiv.style.display = "block";
              setTimeout(() => { errorDiv.style.display = "none"; }, 3000);
            } else if (yearValue > 9999) {
              this.value = "9999";
              errorDiv.textContent = "El a√±o m√°ximo es 9999";
              errorDiv.style.display = "block";
              setTimeout(() => { errorDiv.style.display = "none"; }, 3000);
            }
          }
        });

        // Validar d√≠a seg√∫n mes
        function validateDay() {
          const day = parseInt(dayInput.value);
          const month = parseInt(monthSelect.value);
          const year = parseInt(yearInput.value);

          if (!day || !month) return true;

          const daysInMonth = new Date(year || 2025, month, 0).getDate();

          if (day > daysInMonth) {
            dayInput.classList.add("invalid");
            errorDiv.textContent = `${
              monthSelect.options[monthSelect.selectedIndex].text
            } solo tiene ${daysInMonth} d√≠as`;
            errorDiv.style.display = "block";
            return false;
          } else {
            dayInput.classList.remove("invalid");
            errorDiv.style.display = "none";
            return true;
          }
        }

        // Actualizar campo oculto al cambiar cualquier valor
        function updateHiddenValue() {
          const day = dayInput.value.padStart(2, "0");
          const month = monthSelect.value;
          const year = yearInput.value;

          if (day && month && year && year.length === 4) {
            hiddenInput.value = `${year}-${month}-${day}`;
            validateDay();
          } else {
            hiddenInput.value = "";
          }
        }

        dayInput.addEventListener("input", updateHiddenValue);
        monthSelect.addEventListener("change", updateHiddenValue);
        yearInput.addEventListener("input", updateHiddenValue);

        dayInput.addEventListener("blur", validateDay);
        monthSelect.addEventListener("change", validateDay);
      }

      // ========== FIN SISTEMA DE FECHAS ==========

      function abrirSimulador() {
        document.getElementById("modalSimulador").style.display = "block";
      }

      function cerrarSimulador() {
        document.getElementById("modalSimulador").style.display = "none";
      }

      function cerrarCredito() {
        document.getElementById("modalCredito").style.display = "none";
      }

      // Funciones para Pr√©stamos
      function abrirRegistroPrestamo() {
        document.getElementById("modalPrestamo").style.display = "block";
        setTimeout(() => {
          createDateInput("fecha-inicio-prestamo", "fecha_inicio", true);
          createDateInput("fecha-fin-prestamo", "fecha_fin", true);
        }, 100);
      }

      function cerrarPrestamo() {
        document.getElementById("modalPrestamo").style.display = "none";
      }

      // Funciones para Tarjetas
      function abrirRegistroTarjeta() {
        document.getElementById("modalTarjeta").style.display = "block";
      }

      function cerrarTarjeta() {
        document.getElementById("modalTarjeta").style.display = "none";
      }

      // Funciones para Gastos TDC
      function abrirGastosTDC(tarjetaId, nombreTarjeta) {
        document.getElementById("modalGastosTDC").style.display = "block";
        document.getElementById("tituloGastosTDC").innerHTML = `üí≥ Gastos de ${nombreTarjeta}`;
        document.getElementById("tarjeta_id_input").value = tarjetaId;

        // Cargar gastos existentes
        fetch(`/api/tarjeta/${tarjetaId}/gastos`)
          .then(response => response.json())
          .then(gastos => {
            let html = '<h3 style="color: #667eea">üìã Gastos Registrados</h3>';

            if (gastos.length === 0) {
              html += '<p style="color: #94a3b8">No hay gastos registrados en esta tarjeta.</p>';
            } else {
              html += '<table style="width: 100%"><tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Tipo</th><th>MSI</th></tr>';

              gastos.forEach(gasto => {
                const msiInfo = gasto.tipo === 'msi'
                  ? `${gasto.meses_restantes}/${gasto.meses_msi} meses ($ ${gasto.mensualidad_msi.toFixed(2)}/mes)`
                  : '-';

                html += `
                  <tr>
                    <td>${gasto.fecha}</td>
                    <td>${gasto.concepto}</td>
                    <td>$${gasto.monto.toFixed(2)}</td>
                    <td>${gasto.tipo === 'msi' ? 'MSI' : 'Corriente'}</td>
                    <td>${msiInfo}</td>
                  </tr>
                `;
              });

              html += '</table>';
            }

            document.getElementById("listaGastosTDC").innerHTML = html;
          });
      }

      function cerrarGastosTDC() {
        document.getElementById("modalGastosTDC").style.display = "none";
      }

      function toggleMSITDC() {
        const checkbox = document.getElementById("es_msi_tdc");
        const msiFields = document.getElementById("msiFieldsTDC");
        const tipoInput = document.getElementById("tipo_gasto_tdc");

        if (checkbox.checked) {
          msiFields.style.display = "block";
          tipoInput.value = "msi";
        } else {
          msiFields.style.display = "none";
          tipoInput.value = "corriente";
        }
      }

      function abrirPagoAnticipado(id, producto, mesesRestantes) {
        document.getElementById("modalPagoAnticipado").style.display = "block";
        document.getElementById("infoPagoAnticipado").innerHTML = `
                <strong>Producto:</strong> ${producto}<br>
                <strong>Meses restantes:</strong> ${mesesRestantes}
            `;
        document.getElementById("mesesPagados").max = mesesRestantes;
        document.getElementById(
          "formPagoAnticipado"
        ).action = `/pago_anticipado_msi/${id}`;
      }

      function cerrarPagoAnticipado() {
        document.getElementById("modalPagoAnticipado").style.display = "none";
      }

      function abrirEditarBalance() {
        document.getElementById("modalEditarBalance").style.display = "block";
      }

      function cerrarEditarBalance() {
        document.getElementById("modalEditarBalance").style.display = "none";
      }

      function abrirVistaQuincenal() {
        document.getElementById("modalVistaQuincenal").style.display = "block";
      }

      function cerrarVistaQuincenal() {
        document.getElementById("modalVistaQuincenal").style.display = "none";
      }

      function toggleCamposQuincenales() {
        const checkbox = document.getElementById("checkVistaQuincenal");
        const campos = document.getElementById("camposQuincenales");
        campos.style.display = checkbox.checked ? "block" : "none";
      }

      function cerrarIngresoRecurrente() {
        document.getElementById("modalIngresoRecurrente").style.display =
          "none";
      }

      function abrirRegistroGasto() {
        document.getElementById("modalGasto").style.display = "block";
        // Inicializar componente de fecha para efectivo (por defecto)
        setTimeout(() => {
          createDateInput("fecha-gasto", "fecha", true);
          // Resetear el formulario
          document.getElementById("tipoPagoGasto").value = "efectivo";
          cambiarTipoPagoGasto();
        }, 100);
      }

      function cerrarGasto() {
        document.getElementById("modalGasto").style.display = "none";
        // Limpiar el formulario
        document.getElementById("formGasto").reset();
      }

      // Nueva funci√≥n para cambiar entre efectivo y tarjeta
      function cambiarTipoPagoGasto() {
        const tipoPago = document.getElementById("tipoPagoGasto").value;
        const camposEfectivo = document.getElementById("camposEfectivo");
        const camposTarjeta = document.getElementById("camposTarjeta");
        const selectTarjeta = document.getElementById("tarjetaGastoSelect");

        if (tipoPago === "efectivo") {
          // Mostrar campos de efectivo/transferencia
          camposEfectivo.style.display = "block";
          camposTarjeta.style.display = "none";

          // Habilitar campos de fecha para efectivo
          const camposFechaEfectivo = document.querySelectorAll('#camposEfectivo select, #camposEfectivo input');
          camposFechaEfectivo.forEach(campo => {
            campo.disabled = false;
          });

          // Limpiar y deshabilitar campos de tarjeta
          selectTarjeta.required = false;
          selectTarjeta.disabled = true;
          selectTarjeta.value = "";
          document.getElementById("opcionesCorte").style.display = "none";
          document.getElementById("checkboxMSI").checked = false;
          document.getElementById("msiFields").style.display = "none";

        } else if (tipoPago === "tarjeta") {
          // Mostrar campos de tarjeta de cr√©dito
          camposEfectivo.style.display = "none";
          camposTarjeta.style.display = "block";

          // Deshabilitar campos de fecha de efectivo (para que no bloqueen el submit)
          const camposFechaEfectivo = document.querySelectorAll('#camposEfectivo select, #camposEfectivo input');
          camposFechaEfectivo.forEach(campo => {
            campo.disabled = true;
            campo.required = false;
          });

          // Hacer obligatorio el selector de tarjeta
          selectTarjeta.required = true;
          selectTarjeta.disabled = false;
        }
      }

      // Funci√≥n para mostrar opciones de corte cuando se selecciona una tarjeta
      function mostrarOpcionesCorte() {
        const selectTarjeta = document.getElementById("tarjetaGastoSelect");
        const opcionesCorte = document.getElementById("opcionesCorte");

        if (selectTarjeta.value) {
          opcionesCorte.style.display = "block";
          // Establecer por defecto "pr√≥ximo corte"
          document.getElementById("seleccionCorte").value = "proximo";
          actualizarFechaCorte();
        } else {
          opcionesCorte.style.display = "none";
        }
      }

      // Funci√≥n para actualizar la fecha seg√∫n la opci√≥n de corte seleccionada
      function actualizarFechaCorte() {
        const selectTarjeta = document.getElementById("tarjetaGastoSelect");
        const seleccionCorte = document.getElementById("seleccionCorte").value;
        const infoFechaCorte = document.getElementById("infoFechaCorte");
        const selectedOption = selectTarjeta.options[selectTarjeta.selectedIndex];

        if (!selectedOption || !selectedOption.value) return;

        const diaCorte = parseInt(selectedOption.dataset.fechaCorte);
        const hoy = new Date();
        const mesActual = hoy.getMonth(); // 0-11
        const anioActual = hoy.getFullYear();
        const diaActual = hoy.getDate();

        let fechaCorte;

        if (seleccionCorte === "proximo") {
          // Pr√≥ximo corte
          if (diaActual <= diaCorte) {
            // El corte de este mes a√∫n no ha pasado
            fechaCorte = new Date(anioActual, mesActual, diaCorte);
          } else {
            // El corte ya pas√≥, usar el del pr√≥ximo mes
            fechaCorte = new Date(anioActual, mesActual + 1, diaCorte);
          }
          infoFechaCorte.textContent = `Se registrar√° en el pr√≥ximo corte (${diaCorte} de ${fechaCorte.toLocaleDateString('es-MX', {month: 'long', year: 'numeric'})})`;
        } else {
          // Corte anterior
          if (diaActual <= diaCorte) {
            // El corte de este mes a√∫n no ha pasado, usar el del mes pasado
            fechaCorte = new Date(anioActual, mesActual - 1, diaCorte);
          } else {
            // El corte ya pas√≥, usar el de este mes
            fechaCorte = new Date(anioActual, mesActual, diaCorte);
          }
          infoFechaCorte.textContent = `Se registrar√° en el corte anterior (${diaCorte} de ${fechaCorte.toLocaleDateString('es-MX', {month: 'long', year: 'numeric'})})`;
        }

        // Guardar la fecha en el campo oculto
        const fechaStr = fechaCorte.getFullYear() + '-' +
                        String(fechaCorte.getMonth() + 1).padStart(2, '0') + '-' +
                        String(fechaCorte.getDate()).padStart(2, '0');
        document.getElementById("fechaTarjetaHidden").value = fechaStr;

        // Si MSI est√° activado, tambi√©n actualizar su fecha
        const checkboxMSI = document.getElementById("checkboxMSI");
        if (checkboxMSI && checkboxMSI.checked) {
          document.getElementById("fechaPrimeraMSIHidden").value = fechaStr;
        }
      }

      function cambiarTipoCalculoMSI() {
        const tipo = document.getElementById("tipoCalculoMSI").value;
        const opcionMensualidad = document.getElementById("opcionMensualidad");
        const opcionTotal = document.getElementById("opcionTotal");

        if (tipo === "tengo_mensualidad") {
          opcionMensualidad.style.display = "block";
          opcionTotal.style.display = "none";
          // Habilitar campos de mensualidad
          document.getElementById("mensualidadMSI").required = true;
          document.getElementById("mesesRestantesMSI").required = true;
          // Deshabilitar campos de total
          document.getElementById("totalCompraMSI").required = false;
          document.getElementById("mesesTotalesMSI").required = false;
          // Limpiar campos de total
          document.getElementById("totalCompraMSI").value = "";
          document.getElementById("mesesTotalesMSI").value = "";
          document.getElementById("mensualidadCalculadaDesdeTotal").textContent = "$0.00";
        } else {
          opcionMensualidad.style.display = "none";
          opcionTotal.style.display = "block";
          // Deshabilitar campos de mensualidad
          document.getElementById("mensualidadMSI").required = false;
          document.getElementById("mesesRestantesMSI").required = false;
          // Habilitar campos de total
          document.getElementById("totalCompraMSI").required = true;
          document.getElementById("mesesTotalesMSI").required = true;
          // Limpiar campos de mensualidad
          document.getElementById("mensualidadMSI").value = "";
          document.getElementById("mesesRestantesMSI").value = "";
          document.getElementById("totalCalculadoDesdeMensualidad").textContent = "$0.00";
        }
        // Limpiar monto
        document.getElementById("montoGasto").value = "";
      }

      function calcularDesdeMensualidad() {
        const mensualidad = parseFloat(document.getElementById("mensualidadMSI").value) || 0;
        const meses = parseInt(document.getElementById("mesesRestantesMSI").value) || 0;
        const total = mensualidad * meses;

        // Mostrar el total calculado
        document.getElementById("totalCalculadoDesdeMensualidad").textContent = `$${total.toFixed(2)}`;

        // Actualizar el campo de monto (que se env√≠a al backend)
        document.getElementById("montoGasto").value = total.toFixed(2);
      }

      function calcularDesdeTotal() {
        const total = parseFloat(document.getElementById("totalCompraMSI").value) || 0;
        const meses = parseInt(document.getElementById("mesesTotalesMSI").value) || 0;
        const mensualidad = meses > 0 ? total / meses : 0;

        // Mostrar la mensualidad calculada
        document.getElementById("mensualidadCalculadaDesdeTotal").textContent = `$${mensualidad.toFixed(2)}`;

        // Actualizar el campo de monto (que se env√≠a al backend)
        document.getElementById("montoGasto").value = total.toFixed(2);
      }

      function toggleMSI(checkbox) {
        const msiFields = document.getElementById("msiFields");
        const campoMonto = document.getElementById("campoMonto");

        if (checkbox.checked) {
          msiFields.style.display = "block";
          // Ocultar el campo de monto manual (se calcula autom√°ticamente)
          campoMonto.style.display = "none";
          document.getElementById("montoGasto").required = false;

          // Copiar la fecha del corte seleccionado al campo oculto de MSI
          const fechaCorte = document.getElementById("fechaTarjetaHidden").value;
          document.getElementById("fechaPrimeraMSIHidden").value = fechaCorte;

          // Inicializar con la opci√≥n de mensualidad por defecto
          cambiarTipoCalculoMSI();
        } else {
          msiFields.style.display = "none";
          // Mostrar el campo de monto manual
          campoMonto.style.display = "block";
          document.getElementById("montoGasto").required = true;

          // Limpiar TODOS los campos de MSI
          document.getElementById("mensualidadMSI").value = "";
          document.getElementById("mesesRestantesMSI").value = "";
          document.getElementById("totalCompraMSI").value = "";
          document.getElementById("mesesTotalesMSI").value = "";
          document.getElementById("totalCalculadoDesdeMensualidad").textContent = "$0.00";
          document.getElementById("mensualidadCalculadaDesdeTotal").textContent = "$0.00";
          document.getElementById("montoGasto").value = "";
          document.getElementById("fechaPrimeraMSIHidden").value = "";
        }
      }

      // Validaci√≥n del formulario de gastos
      function validarFormularioGasto() {
        console.log("=== VALIDANDO FORMULARIO DE GASTO ===");
        const tipoPago = document.getElementById("tipoPagoGasto").value;
        console.log("Tipo de pago:", tipoPago);

        if (tipoPago === "tarjeta") {
          // Validar que se haya seleccionado una tarjeta
          const selectTarjeta = document.getElementById("tarjetaGastoSelect");
          console.log("Tarjeta seleccionada:", selectTarjeta.value);
          if (!selectTarjeta.value) {
            alert("Por favor selecciona una tarjeta");
            return false;
          }

          // Validar que se haya establecido la fecha del corte
          const fechaTarjeta = document.getElementById("fechaTarjetaHidden").value;
          console.log("Fecha tarjeta hidden:", fechaTarjeta);
          if (!fechaTarjeta) {
            alert("Por favor espera a que se calcule la fecha del corte");
            return false;
          }

          // Si es MSI, validar seg√∫n qu√© tipo de dato tiene
          const checkboxMSI = document.getElementById("checkboxMSI");
          console.log("MSI checked:", checkboxMSI.checked);
          if (checkboxMSI.checked) {
            const tipoCalculo = document.getElementById("tipoCalculoMSI").value;
            console.log("Tipo de c√°lculo MSI:", tipoCalculo);

            if (tipoCalculo === "tengo_mensualidad") {
              const mensualidad = document.getElementById("mensualidadMSI").value;
              const meses = document.getElementById("mesesRestantesMSI").value;
              if (!mensualidad || !meses || meses < 1 || meses > 72) {
                alert("Por favor completa la mensualidad y meses restantes");
                return false;
              }
            } else {
              const total = document.getElementById("totalCompraMSI").value;
              const meses = document.getElementById("mesesTotalesMSI").value;
              if (!total || !meses || meses < 1 || meses > 72) {
                alert("Por favor completa el total y n√∫mero de meses");
                return false;
              }
            }
          }
        }

        console.log("Validaci√≥n exitosa, enviando formulario...");
        return true; // Permitir env√≠o del formulario
      }

      function toggleMesEspecifico() {
        const frecuenciaSelect = document.getElementById("frecuencia_select");
        const mesEspecificoGroup = document.getElementById("mes_especifico_group");

        if (frecuenciaSelect.value === "anual") {
          mesEspecificoGroup.style.display = "block";
        } else {
          mesEspecificoGroup.style.display = "none";
        }
      }

      async function simularCompra() {
        const producto = document.getElementById("productoSim").value.trim();
        const precio = parseFloat(document.getElementById("precioSim").value);
        const meses = parseInt(document.getElementById("mesesSim").value);

        if (!precio || !meses) {
          alert("Por favor completa el precio y los meses");
          return;
        }

        // Mostrar loading
        document.getElementById("resultadoSim").innerHTML = '<p style="text-align: center; color: #cbd5e1;">‚è≥ Calculando proyecci√≥n...</p>';
        document.getElementById("resultadoSim").style.display = "block";

        try {
          const response = await fetch("/simular_compra", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ producto, precio, meses }),
          });

          if (!response.ok) {
            throw new Error('Error en la simulaci√≥n');
          }

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          // Construir HTML del resultado
          let html = `
                  <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--card-border);">
                      <h3 style="margin-bottom: 15px; color: var(--text-primary);">üìä Resultado de la Simulaci√≥n</h3>

                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                          <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                              <small style="color: var(--text-secondary); display: block; margin-bottom: 4px;">Mensualidad</small>
                              <strong style="color: #60a5fa; font-size: 1.3em;">$${data.mensualidad.toFixed(2)}</strong>
                          </div>
                          <div style="background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                              <small style="color: var(--text-secondary); display: block; margin-bottom: 4px;">Saldo Actual</small>
                              <strong style="color: #818cf8; font-size: 1.3em;">$${data.saldo_inicial.toFixed(2)}</strong>
                          </div>
                          <div style="background: ${data.saldo_final >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; padding: 12px; border-radius: 8px; border: 1px solid ${data.saldo_final >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">
                              <small style="color: var(--text-secondary); display: block; margin-bottom: 4px;">Saldo Final (${meses} meses)</small>
                              <strong style="color: ${data.saldo_final >= 0 ? '#10b981' : '#ef4444'}; font-size: 1.3em;">$${data.saldo_final.toFixed(2)}</strong>
                          </div>
                      </div>

                      <div class="veredicto" style="text-align: center; padding: 20px; border-radius: 10px; font-size: 1.4em; font-weight: bold; margin-bottom: 20px;
                          ${data.veredicto.includes('SI ‚úÖ') ? 'background: var(--success-bg); border: 2px solid var(--success-border); color: var(--success-text);' :
                            data.veredicto.includes('CUIDADO') ? 'background: var(--warning-bg); border: 2px solid var(--warning-border); color: var(--warning-text);' :
                            'background: var(--danger-bg); border: 2px solid var(--danger-border); color: var(--danger-text);'}">
                          ${data.veredicto}
                          ${data.mes_critico ? `<br><small style="font-size: 0.7em; opacity: 0.9;">Problema detectado en ${data.mes_critico}</small>` : ''}
                      </div>

                      <h4 style="margin: 20px 0 10px 0; color: var(--text-primary);">üìà Proyecci√≥n Mes a Mes</h4>
                      <div style="overflow-x: auto;">
                          <table style="width: 100%; min-width: 900px; border-collapse: collapse;">
                              <thead>
                                  <tr style="background: var(--primary-gradient);">
                                      <th style="padding: 12px 15px; text-align: left; color: white; font-size: 0.95em; white-space: nowrap;">Mes</th>
                                      <th style="padding: 12px 15px; text-align: right; color: white; font-size: 0.95em; white-space: nowrap;">Ingresos</th>
                                      <th style="padding: 12px 15px; text-align: right; color: white; font-size: 0.95em; white-space: nowrap;">Gastos</th>
                                      <th style="padding: 12px 15px; text-align: right; color: white; font-size: 0.95em; white-space: nowrap;">MSI</th>
                                      <th style="padding: 12px 15px; text-align: right; color: white; font-size: 0.95em; white-space: nowrap;">Sin Compra</th>
                                      <th style="padding: 12px 15px; text-align: right; color: white; font-size: 0.95em; white-space: nowrap;">Con Compra</th>
                                      <th style="padding: 12px 15px; text-align: center; color: white; font-size: 0.95em; white-space: nowrap;">Estado</th>
                                  </tr>
                              </thead>
                              <tbody>
              `;

          data.proyeccion.forEach((p) => {
            const emoji = p.estado_con === "verde" ? "üü¢" : p.estado_con === "amarillo" ? "üü°" : "üî¥";
            const rowColor = p.estado_con === "rojo" ? "rgba(127, 29, 29, 0.2)" : "";

            html += `
                                  <tr style="border-bottom: 1px solid var(--card-border); background: ${rowColor};">
                                      <td style="padding: 12px 15px; color: var(--text-primary); white-space: nowrap;">${p.mes}</td>
                                      <td style="padding: 12px 15px; text-align: right; color: var(--success-text); white-space: nowrap;">+$${p.ingresos.toFixed(2)}</td>
                                      <td style="padding: 12px 15px; text-align: right; color: var(--danger-text); white-space: nowrap;">-$${p.gastos.toFixed(2)}</td>
                                      <td style="padding: 12px 15px; text-align: right; color: var(--warning-text); white-space: nowrap;">${p.mensualidad_msi > 0 ? '-$' + p.mensualidad_msi.toFixed(2) : '-'}</td>
                                      <td style="padding: 12px 15px; text-align: right; color: var(--text-secondary); opacity: 0.7; white-space: nowrap;">$${p.saldo_sin_compra.toFixed(2)}</td>
                                      <td style="padding: 12px 15px; text-align: right; color: var(--text-primary); font-weight: bold; white-space: nowrap;">$${p.saldo_con_compra.toFixed(2)}</td>
                                      <td style="padding: 12px 15px; text-align: center; font-size: 1.2em;">${emoji}</td>
                                  </tr>
                              `;
          });

          html += `
                              </tbody>
                          </table>
                      </div>

                      <div style="margin-top: 15px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid #6366f1;">
                          <small style="color: var(--text-secondary); display: block; margin-bottom: 5px;">üí° <strong>Leyenda:</strong></small>
                          <small style="color: var(--text-secondary);">
                              üü¢ Saldo > $10,000 &nbsp;|&nbsp;
                              üü° Saldo $0 - $10,000 &nbsp;|&nbsp;
                              üî¥ Saldo negativo (¬°cuidado!)
                          </small>
                      </div>
                  </div>
              `;

          document.getElementById("resultadoSim").innerHTML = html;

        } catch (error) {
          document.getElementById("resultadoSim").innerHTML = `
              <div style="background: var(--danger-bg); padding: 20px; border-radius: 12px; border: 2px solid var(--danger-border); color: var(--danger-text); text-align: center;">
                  <h3>‚ùå Error</h3>
                  <p>${error.message || 'No se pudo realizar la simulaci√≥n'}</p>
              </div>
          `;
        }
      }

      // Modal solo se cierra con el bot√≥n X (no al hacer click fuera)

      // Validar campos de fecha (solo 4 d√≠gitos en a√±o)
      document.addEventListener("DOMContentLoaded", function () {
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach((input) => {
          // Validar al cambiar (blur)
          input.addEventListener("blur", function (e) {
            const value = e.target.value;
            if (value) {
              const parts = value.split("-");
              const year = parseInt(parts[0]);

              // Si el a√±o est√° fuera de rango, corregir
              if (year < 2020 || year > 2099) {
                alert("El a√±o debe estar entre 2020 y 2099");
                e.target.value = "";
              }
            }
          });

          // Validar al enviar el formulario
          input.form?.addEventListener("submit", function (event) {
            const value = input.value;
            if (value) {
              const parts = value.split("-");
              const year = parseInt(parts[0]);

              if (year < 2020 || year > 2099) {
                event.preventDefault();
                alert("El a√±o debe estar entre 2020 y 2099");
                input.focus();
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
